<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juleaf Editor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-right: auto;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header h1 img {
            height: 28px;
            width: auto;
        }
        
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .btn:hover { background: #2980b9; transform: translateY(-1px); }
        .btn:disabled { background: #95a5a6; cursor: not-allowed; transform: none; }
        .btn.compile { background: #27ae60; }
        .btn.compile:hover { background: #219a52; }
        
        .status {
            font-size: 12px;
            color: #ecf0f1;
            padding: 4px 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
        }
        
        .container {
            display: flex;
            height: calc(100vh - 48px);
        }
        
        .container.panel-open { height: calc(100vh - 48px - 280px); }
        
        .editor-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }
        
        .resizer {
            width: 6px;
            background: #bdc3c7;
            cursor: col-resize;
            flex-shrink: 0;
            transition: background 0.2s;
        }
        
        .resizer:hover { background: #3498db; }
        
        .editor-header {
            background: #ecf0f1;
            padding: 8px 12px;
            font-size: 12px;
            color: #555;
            border-bottom: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .editor {
            flex: 1;
            border: none;
            padding: 16px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: none;
            outline: none;
            tab-size: 2;
        }
        
        .preview-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
        }
        
        .preview-header {
            background: #ecf0f1;
            padding: 8px 12px;
            font-size: 12px;
            color: #555;
            border-bottom: 1px solid #ccc;
        }
        
        .pdf-viewer {
            flex: 1;
            border: none;
            background: #525659;
        }
        
        .console-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 280px;
            background: #1e1e1e;
            border-top: 3px solid #3498db;
            display: none;
            flex-direction: column;
            z-index: 1000;
        }
        
        .console-panel.visible { display: flex; }
        
        .console-header {
            background: #2c2c2c;
            padding: 8px 12px;
            color: #ccc;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .console-close {
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 18px;
            padding: 0 8px;
            transition: color 0.2s;
        }
        
        .console-close:hover { color: #fff; }
        
        .console-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            font-family: 'JetBrains Mono', 'Monaco', monospace;
            font-size: 11px;
            line-height: 1.5;
            color: #d4d4d4;
            white-space: pre-wrap;
        }
        
        .console-content .error { color: #e74c3c; }
        .console-content .success { color: #27ae60; }
        
        .settings-textarea {
            width: 100%;
            height: 100%;
            background: #1e1e1e;
            color: #d4d4d4;
            border: none;
            font-family: 'JetBrains Mono', 'Monaco', monospace;
            font-size: 12px;
            padding: 12px;
            resize: none;
            outline: none;
        }
        
        body.dark-theme { background: #1e1e1e; }
        body.dark-theme .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); }
        body.dark-theme .editor { background: #252526; color: #d4d4d4; }
        body.dark-theme .editor-header,
        body.dark-theme .preview-header { background: #2d2d2d; color: #ccc; border-bottom-color: #444; }
        body.dark-theme .preview-pane { background: #1e1e1e; }
        body.dark-theme .resizer { background: #444; }
        
        select.btn {
            appearance: none;
            padding-right: 24px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='white' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><img src="/logo" alt="Juleaf">Juleaf</h1>
        <select class="btn" id="templateSelect" onchange="loadTemplate()">
            <option value="">üìÑ Templates</option>
            <option value="article">Article / Report</option>
            <option value="ieee">IEEE Conference</option>
            <option value="beamer">Beamer Slides</option>
            <option value="letter">Letter</option>
            <option value="mathpaper">Math Paper</option>
        </select>
        <button class="btn compile" onclick="compile()">‚ñ∂ Compile</button>
        <button class="btn" onclick="toggleConsole()">Console</button>
        <button class="btn" onclick="toggleSettings()">‚öô Packages</button>
        <button class="btn" onclick="toggleTheme()" id="themeBtn">üåô</button>
        <span class="status" id="status">Ready</span>
    </div>
    
    <div class="container">
        <div class="editor-pane">
            <div class="editor-header">
                <span id="editorHeader">document.jmd</span>
                <span style="color:#888">Ctrl+S to compile</span>
            </div>
            <textarea class="editor" id="editor" spellcheck="false">---
title: "Welcome to Juleaf"
author: "Your Name"
date: today
---

# Getting Started

**Juleaf** = Julia + Weave + LaTeX ‚Äî write scientific documents with executable code!

## Features

- **Julia code execution** with inline results
- **LaTeX math**: $E = mc^2$ and display equations
- **Live PDF preview**

## Example: Julia Code

```julia
using Statistics
x = randn(100)
println("Mean: ", round(mean(x), digits=3))
println("Std:  ", round(std(x), digits=3))
```

## Math Example

The quadratic formula:
$$
x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}
$$

---

Select a **template** from the dropdown to get started with IEEE papers, Beamer presentations, and more!
</textarea>
        </div>
        
        <div class="resizer" id="resizer"></div>
        
        <div class="preview-pane" id="previewPane">
            <div class="preview-header">Preview (PDF)</div>
            <iframe class="pdf-viewer" id="preview"></iframe>
        </div>
    </div>
    
    <div class="console-panel" id="console">
        <div class="console-header">
            <span>üìã Compilation Console</span>
            <button class="console-close" onclick="toggleConsole()">√ó</button>
        </div>
        <div class="console-content" id="console-output">Waiting for compilation...</div>
    </div>
    
    <div class="console-panel" id="settings">
        <div class="console-header">
            <span>‚öô LaTeX Packages (header-includes)</span>
            <button class="console-close" onclick="toggleSettings()">√ó</button>
        </div>
        <div class="console-content">
            <textarea id="custom-packages" class="settings-textarea" placeholder="Add LaTeX packages here, e.g.:
\usepackage{algorithm}
\usepackage{booktabs}

These will be injected into header-includes."></textarea>
        </div>
    </div>
    
    <script>
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const status = document.getElementById('status');
        const resizer = document.getElementById('resizer');
        const editorPane = document.querySelector('.editor-pane');
        const previewPane = document.getElementById('previewPane');
        const editorHeader = document.getElementById('editorHeader');
        
        let compiling = false;
        let autoCompileTimeout = null;
        let isFirstCompile = true;
        let isResizing = false;
        let currentFileType = 'jmd';
        
        const templates = {
            article: {
                code: `---
title: "Article Title"
author: "Author Name"
date: today
---

# Introduction

Your introduction here.

## Background

Background information with citations and references.

# Methods

## Data Collection

Describe your methodology.

\`\`\`julia
using Statistics
data = randn(1000)
println("Sample size: ", length(data))
println("Mean: ", round(mean(data), digits=4))
\`\`\`

## Analysis

Mathematical formulation:
$$
\\mathcal{L}(\\theta) = \\sum_{i=1}^n \\log p(x_i | \\theta)
$$

# Results

\`\`\`julia
using CairoMakie
fig = Figure(size=(500, 300))
ax = Axis(fig[1,1], xlabel="Value", ylabel="Frequency")
hist!(ax, data, bins=30)
fig
\`\`\`

# Conclusion

Summary of findings.

# References`,
                packages: `\\usepackage{booktabs}
\\usepackage{hyperref}`,
                filetype: 'jmd'
            },
            
            ieee: {
                code: `---
documentclass: IEEEtran
classoption: conference
---

\\title{Your Paper Title Here}

\\author{
\\IEEEauthorblockN{First Author}
\\IEEEauthorblockA{\\textit{Department Name} \\\\
\\textit{University Name}\\\\
City, Country \\\\
email@example.com}
\\and
\\IEEEauthorblockN{Second Author}
\\IEEEauthorblockA{\\textit{Department Name} \\\\
\\textit{University Name}\\\\
City, Country \\\\
email@example.com}
}

\\maketitle

\\begin{abstract}
Your abstract here. Keep it concise (150-250 words).
\\end{abstract}

\\begin{IEEEkeywords}
keyword1, keyword2, keyword3
\\end{IEEEkeywords}

\\section{Introduction}
Introduction text here.

\\section{Related Work}
Literature review.

\\section{Methodology}

\\subsection{Problem Formulation}
The optimization problem:
$$
\\min_{\\mathbf{x}} f(\\mathbf{x}) = \\|\\mathbf{Ax} - \\mathbf{b}\\|_2^2
$$

\\subsection{Implementation}

\`\`\`julia
using LinearAlgebra
A = randn(100, 10)
b = randn(100)
x = A \\ b
println("Solution norm: ", round(norm(x), digits=4))
\`\`\`

\\section{Results}

\`\`\`julia
using CairoMakie
residual = A * x - b
fig = Figure(size=(500, 300))
ax = Axis(fig[1,1], xlabel="Index", ylabel="Residual")
scatter!(ax, 1:length(residual), residual, markersize=4)
fig
\`\`\`

\\section{Conclusion}
Conclusions and future work.

\\begin{thebibliography}{00}
\\bibitem{b1} A. Author, "Paper Title," Journal Name, vol. 1, pp. 1-10, 2024.
\\end{thebibliography}`,
                packages: `\\usepackage{cite}
\\usepackage{amsmath,amssymb}
\\usepackage{graphicx}
\\usepackage{xcolor}`,
                filetype: 'jmd'
            },
            
            beamer: {
                code: `---
title: "Presentation Title"
author: "Your Name"
institute: "Your Institution"
date: today
documentclass: beamer
theme: Madrid
colortheme: whale
---

# Introduction

## Welcome

This is a **Beamer presentation** created with Juleaf!

Features:

- Julia code execution
- LaTeX math support  
- Automatic PDF generation

## Outline

1. Introduction
2. Methods
3. Results
4. Conclusion

# Methods

## Mathematical Framework

The key equation:

$$
\\nabla f(x) = \\sum_{i=1}^n \\frac{\\partial f}{\\partial x_i} \\mathbf{e}_i
$$

## Algorithm

1. Initialize parameters
2. Compute gradient
3. Update weights
4. Repeat until convergence

# Results

## Numerical Example

\`\`\`julia
using Statistics
x = randn(1000)
println("Mean: ", round(mean(x), digits=4))
println("Std:  ", round(std(x), digits=4))
\`\`\`

## Visualization

\`\`\`julia
using CairoMakie
fig = Figure(size=(450, 280))
ax = Axis(fig[1,1], xlabel="x", ylabel="Density")
hist!(ax, x, bins=25, normalization=:pdf)
fig
\`\`\`

# Conclusion

## Summary

- Point 1
- Point 2
- Point 3

## Thank You!

Questions?

**Contact:** your.email@example.com`,
                packages: ``,
                filetype: 'jmd'
            },
            
            letter: {
                code: `---
documentclass: letter
---

\\documentclass{letter}
\\usepackage[margin=1in]{geometry}

\\address{Your Name \\\\ Your Address \\\\ City, Country}
\\date{\\today}

\\begin{document}

\\begin{letter}{Recipient Name \\\\ Recipient Address \\\\ City, Country}

\\opening{Dear Sir or Madam,}

I am writing to inquire about...

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.

\\closing{Sincerely,}

\\end{letter}

\\end{document}`,
                packages: ``,
                filetype: 'jmd'
            },
            
            mathpaper: {
                code: `---
title: "Mathematical Analysis"
author: "Author Name"
date: today
header-includes:
  - \\usepackage{amsthm}
  - \\newtheorem{theorem}{Theorem}
  - \\newtheorem{lemma}{Lemma}
  - \\newtheorem{definition}{Definition}
---

# Introduction

This document demonstrates mathematical typesetting with Julia computations.

# Preliminaries

\\begin{definition}
A function $f: \\mathbb{R} \\to \\mathbb{R}$ is \\textbf{continuous} at $x_0$ if:
$$
\\lim_{x \\to x_0} f(x) = f(x_0)
$$
\\end{definition}

# Main Results

\\begin{theorem}
Let $f$ be continuous on $[a,b]$. Then $f$ is integrable on $[a,b]$.
\\end{theorem}

\\begin{lemma}
For any $\\epsilon > 0$, there exists $\\delta > 0$ such that...
\\end{lemma}

## Numerical Verification

\`\`\`julia
using QuadGK

f(x) = exp(-x^2)
result, err = quadgk(f, -Inf, Inf)
println("‚à´ exp(-x¬≤) dx = ", round(result, digits=6))
println("‚àöœÄ = ", round(sqrt(œÄ), digits=6))
\`\`\`

# Conclusion

The numerical results confirm the theoretical predictions.`,
                packages: `\\usepackage{amsmath,amssymb}
\\usepackage{mathtools}`,
                filetype: 'jmd'
            }
        };
        
        function loadTemplate() {
            const select = document.getElementById('templateSelect');
            const key = select.value;
            
            if (key && templates[key]) {
                if (confirm('Load template? This replaces current content.')) {
                    editor.value = templates[key].code;
                    document.getElementById('custom-packages').value = templates[key].packages;
                    localStorage.setItem('latex-packages', templates[key].packages);
                    currentFileType = templates[key].filetype;
                    editorHeader.textContent = `document.${currentFileType}`;
                    compile();
                }
                select.value = '';
            }
        }
        
        // Resizer
        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const containerWidth = document.querySelector('.container').offsetWidth;
            const percent = (e.clientX / containerWidth) * 100;
            if (percent > 20 && percent < 80) {
                editorPane.style.flex = `0 0 ${percent}%`;
                previewPane.style.flex = `0 0 ${100 - percent}%`;
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        });
        
        async function compile() {
            if (compiling) return;
            
            compiling = true;
            status.textContent = '‚è≥ Compiling...';
            
            try {
                const content = editor.value;
                const packages = document.getElementById('custom-packages').value;
                
                const response = await fetch('/compile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                        'X-LaTeX-Packages': btoa(unescape(encodeURIComponent(packages))),
                        'X-File-Type': currentFileType
                    },
                    body: content
                });
                
                const logsHeader = response.headers.get('X-Compilation-Logs');
                if (logsHeader) {
                    try {
                        const logs = decodeURIComponent(escape(atob(logsHeader)));
                        displayLogs(logs);
                    } catch { displayLogs(atob(logsHeader)); }
                }
                
                if (response.ok) {
                    const timestamp = Date.now();
                    preview.src = '/output.pdf?t=' + timestamp;
                    isFirstCompile = false;
                    status.textContent = '‚úì Compiled';
                    setTimeout(() => status.textContent = 'Ready', 2000);
                } else {
                    status.textContent = '‚úó Failed';
                    document.getElementById('console').classList.add('visible');
                    document.querySelector('.container').classList.add('panel-open');
                }
            } catch (error) {
                status.textContent = '‚úó Error';
                console.error(error);
            } finally {
                compiling = false;
            }
        }
        
        editor.addEventListener('input', () => {
            clearTimeout(autoCompileTimeout);
            autoCompileTimeout = setTimeout(compile, 1500);
        });
        
        document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 's') {
                e.preventDefault();
                compile();
            }
        });
        
        function toggleConsole() {
            const consolePanel = document.getElementById('console');
            const settingsPanel = document.getElementById('settings');
            const container = document.querySelector('.container');
            settingsPanel.classList.remove('visible');
            consolePanel.classList.toggle('visible');
            container.classList.toggle('panel-open', consolePanel.classList.contains('visible'));
        }
        
        function toggleSettings() {
            const consolePanel = document.getElementById('console');
            const settingsPanel = document.getElementById('settings');
            const container = document.querySelector('.container');
            consolePanel.classList.remove('visible');
            settingsPanel.classList.toggle('visible');
            container.classList.toggle('panel-open', settingsPanel.classList.contains('visible'));
        }
        
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            document.getElementById('themeBtn').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
        
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-theme');
            document.getElementById('themeBtn').textContent = '‚òÄÔ∏è';
        }
        
        function displayLogs(logs) {
            const consoleOutput = document.getElementById('console-output');
            let formatted = logs
                .replace(/Error:/g, '<span class="error">Error:</span>')
                .replace(/‚úì/g, '<span class="success">‚úì</span>')
                .replace(/‚úó/g, '<span class="error">‚úó</span>');
            consoleOutput.innerHTML = formatted;
        }
        
        const packagesTextarea = document.getElementById('custom-packages');
        packagesTextarea.value = localStorage.getItem('latex-packages') || '';
        packagesTextarea.addEventListener('input', (e) => {
            localStorage.setItem('latex-packages', e.target.value);
        });
        
        window.addEventListener('load', compile);
    </script>
</body>
</html>
